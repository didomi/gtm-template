___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Didomi CMP",
  "categories": [
    "TAG_MANAGEMENT",
    "PERSONALIZATION"
  ],
  "brand": {
    "id": "github.com_didomi",
    "displayName": "Didomi",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAQO0lEQVR4nOxaCVhUVfs/59w7MICsDmssgqgQKn4QppgoiRuf4r6UlJlhRuKSgkpmLmllaKFWmsrnTmquqJiKhqh/9wUVB8WVfVgFZpjl3nP+z70H5kPFGcD6fHqe3mfEmXvPPee82+9dzmUJIeDvTOhVb+Bl6R8GXjX9w8Crpr89A6zh2zz+E0AWQgDF/+DLz/X85P/LOIAxwYBAABH605gxpAGOx1ce5/MYQwBJ/cL0VtOXhxBamJrIWlnYWZgxCKH6RzmMGQhfXiuNa4AQAiEsq1G5zVpaW6MCEhYQADgOqDV0U81ZAQCEgEQis7Hyd3N+27dt/04dAtu40ps8xkgvlRaRER8wYVmNiQRrtIyJZPLAXv382ul4XqXRCTbQNDZ4HlfWqvMrntzIK7ryMC/t8o3Peezt5fZxaLfxbwXZW1pQT2NayoUhDVSq1LKYhWF+3kMD/ObvSi2pqvkkrMfC4f3pqi0gTIi8UHHoujwp/bz89j0rJ9nswX1m9O9pJpHwGDOoRZBIGiOMMSGkQlkLPpw9ZOUmQkh+ZdXUrfvAmBjwzrSZySnFVTWEEI7n1TqdjueNfzie43lx1jo6f//xv+b/AIZO9p2z7KT8PiGExw3vN5WMM43FqV2sLRPHDZH/8MWoHoHLdx1uH/v1j2lnMQCmLMtAiABkEXrRhxFxVO+xGo4/duvuLyfP3S1SmNnb5ZSUh36esOTgCQGZxD01SwFGfACIXsggxPEYQNDByX7np++lh701Z+fBKYkbE38/9e2YQcMCO0IouCOEsCE8EgE3MQDC46x4PaugeMuZK5tOXywsUNg7yj4J7T4+JMjS1DRmy955a7ZnFyiSPhpN2WgGOhk1ocErN4rWgqmWeb5Oz8nnr7nP+ApETOq19Kf/y3lEL+oEO8E8xjqe189WWq1ce/Jc0IJEMCYGfhA7avXm329mcw0GEELm/pYKRkSP+WkrjzHXHGNqHgOUxAWEn7U6XUJquvnEOWBEdOSa7fcUZQ0n4TA+evPOqNWbmQmxYMzUN778Ye3Jc6XVSv0AHS+wSz+EkG5frQYDJny8aQ+91UQGmmBCzxGFPB5jKcvOHBASGRywNCVtZUra1lMX4ob2m9m/Z5lStfn0pU2nLxUWKJxdHGYN7P1+j8DXXRzp47xoV0h0D/qTQejwjexzdx72DAlae+C4z2uO0/sENxGXjMCobcyCiC6++2PGNwrVRFye7uOeomzhvmNbTpx1cnaoVNZqtdqRQf4Te3Xt83o7+qCgWELQ09GXiNcBAL7xCQihqwumhX+fdPLKresJczq7OvOEMMac4WWzUf30VmZSazMpQKgor9BDZqP4ceGOTyP7dWzPIMiJBgchZMT41/BxjDGC8D9nLt/Jvr/y3QiphE36cJSFmenEpN8wJk1x5JYzIOZIAsJUqTUL9h1ziJ6/ev+xGRFhY/r0yJbfX3ropIiYnGCmqPHkjeq5RqON237g7eCAvn7ttDzfRmb77fjhly7d2Hb+KoKQ2psBaokPYFHpDEKYkKSMi3N3HCrNLw4PCVo8cmCAu4uO5ytqVCs277WUmi6ICON4zDKNixITwiD0TWp6eUn5D/HRBAAEIcZkckjXxCOn5v12ZEyQv4RhiOHc0SgKRYiRWA+jevg7nCnvFJ8ABkf5z1t+5EY2vagVx1XVqrsvWgUiJiUePyNcbAxSRCTDeeWVbORnket30Liux5/t56+BIZN2Xco0ikhNNSFChAQYiXZ89XFB+PL14V98X1JVkxQ36driz/p3bI9FH5UwiGBiKTXdN32Cn5/3tJ+3bTl3TULj4HOCgxDG7T4CAPh6eH9C6goeBkECwPAAP3s3l5XHzwJRLYZ3ZlwDeqk/Kqv8KGkXGDUFjZ+1cN/Rqlo1vf5MVKI/H5RWeExfDMZOTcmUPyNIqs8rj/LBiOg5u488MwMdOS05BUbOyK94QtXVIg2InEMxlaisVS/af9zrsyXrj5z6KLz3gxXz5g/payk15euThYbPMQjxGLdpbXMwdpLM2nJUwrqMnEcsQtzTHjl1+wFbme3cgb0ovDZcliqB1KpPyO/pva5RMsgAEebieLz9/LVOc5Z9uWl3WMd2F7+NW/fBCHc7a2ru6AWxhhG329HF4UDcxxChIct+ycwvpjyIEQoezJSfPnd18ZhBVmZS8nTyQ7G2i7uLxMb65O17hnZomAEe41ZS06M3ssclbuQJ2T8/5sisqDfqiykTlqErYTFroDujmqYDWNH0u3u57ZkV9aRGOWjZ2gdlFTTqcTyesW2/Z7s2k3oGPSMFIn44jC1MJJ6OssuP8gVxvNgNjDgxBEDHcRILsyod9+mWvV2+TBy3NvmrlBN7Lt+89rigXKmiAqtLmxHSB1qakwEohIIBfu22zfgwN7940HfrCp9UMwitST+fI7+//J0ICcvQxKpeBELwohMyCHV2dXpUVsmJee6LjMhIHBB2w/M6rc7VzfkNT7dbuYW/XryOa2qBVgsYBliYudjZtHVo7efi4OPs6ONs7ymzdbG1bmVqovcKKvKxQZ0rYt6PTlg/bNXm/0wcPXfnoX8F+A3p8joRgIupl1UdFVfVZBeVZOUX38wt1HG8UqMVYjxoPB4YYgBBWKvVdWzjZiU1OZspH+rvu2nhNCnDyItK8iuq5IWK7ELFrQJFjqI0I/s+UNYKVb+JhG1l4Smz9XaU+b3m5Ots397J3qO1TetWFp/0ehMTMmX9zre+Wq3T6rZGjUVIyMRKqpU5irJbeUVXcwsycwvvFpcWV9UAjGVWlkQI9sRwMDbEAIRQy3Ge9na7oiOnbNn7fXJKypVbW6Mj3/Ry83V2CHvdWz+yUlWbW/7kYWlFVmGxvECRVai4+CA39cotoFYDTIDU1NxS4KpHO09XJ1lefrGHm8vG05fO3398p6ikqLIa6HRIaurR2rbja46TQ7sHeLh0cLT3dmw9+7cjK45mmLKGNmkslYBQqdGassy6CSP7dmw/8ZfkbnOXLX1/+Ozw3ghCjY5jGYZB0MbczMbcrJOr0+AuvvQ5HuPSGtWjsop7irKb+cW5ZRV3FGW/HDsNEETmZkWVVRtOXfB1cRgV1DnQ4zU/V6d2jjLRTp4iRVWNjblUKmHBi3s5xnMh6kA6zI8O6vyGp1vU+h3xP29Lz8pZO3GUh52NGGIADdWEpsYQ0IDtaNXK0apVV083AECpUjVnx8HzWTmtra3Lyiu7+/uejJv0/Fp0NrGoBAyDHpVVOFtbMgiRFxeZTSrqIQQUwr1ktsfnTF40aezvF675z/1uz5WbNEPGBCAkbJplBDiCUEihKWwUV9XM+jXFPip+w7EzX48bMjjADwCQLr936WEej7GG4yj4kPoEkRWwTPgLCJEXl/o4O7xEIKNBsQGuY7EG/SIi7MTimVZm0hGLVk3dtl+l0wlJf322w2NhDIuQjudXHT/TIe6b5TsPjwwOvJM4f2pYcHL6haXvRnR2d4nf8zujb1s83SajK+ZVPFEUl3XzcqfqfREZN6GGJRsN+BzGoT5eV5bMnLJpz6rklFNZOUkfvxPg7tIwrdh1MTN+1+Gc2/cCA/y+mz4h1KctACB6236A4Nx/h7aR2b77fVJ2UUl7R/tn8oh6ncOMOw+BVhvS3tNwY9uYCUH4PIaxYqojszD/NTry51kfZT7OD4xPWJV2lhGjzx/Z93su+Wn04tVPVOoNcZMuLZwe6tOWw1hRVbPu2Om4IX0BAMMCOjo6yr48cJy2gp5dU3TY5IvXrRzs/N2cDSekzdOAnqhjEQIm9+7W3dtj/Jrkqcs3ZNx5YMIy21LTgYV5/PvDY8N725gLwKLleBOW+e5oBsswn/XtgQmRStjPI8KmJu36buRAVzubhkoQMwuoqKo5evnm2J5BUglrpLo3nE7DiXOCl/5kIKGlqa+G42J/PQjGxIB3p4/+cYu8UKG/SzOF8hqV6YTZcb+likWPUCQL8XXyvI83730m06bfhYp02OSMOw+ez9Wbk06/WAN6onIjANTqOMDxvm1cd0RHdnCy50SG2ToEBCuOneYxju0XQohogYSYm0hm/jt0/fEzJdVKWp3StRCE1WrN8oMnOnXq0MPbg5adBjZgmAFiGAE4Ubk5JeU9FqxcvTu1V1Dnu4rS67mFghmIvVD9hlYcOvnpgBCZpTlPhMyMgULZFfN2sIRlEo5mwHqg5MXx3xxJL8svXjK8P53BsHybAKOg8cYRLwo49Wb2G/EJl+8+2BgblRYbBQg5cfueUJuLT1E8WZl2Vq3RzhnYi5A6d4Riu8HGXPpp/5BVqelVtWrafmURupFf/PWOQ2EhXQf7+xoVf5MC2fMiwJhQKS5L/SP8y0RLM+mZJbPGBwcyCAV5eRy4flsfv5GYiXx7IC2q71tO1paYYL2zIlEJsQNCNFrdjyfPUUlpOO69NdukpiZr3x/WxCZ1U31AD2NCaY9gtUY7bs222au39OvW5eJXnwW3dVfrdASAQZ19zt19qNJqGSEY8xDCNennq5WqeYNCydNwLnZQsKNVqwl9gpelpOl4XsIwURt3X78uX/vJOC97O4yfjQ8tZaDBd6rlrMKSHgsTt6emx44fnho7ycmqFY+xhGUhAP07tlfXKC/cz6NQq9ZxS/cfG98n2NXWmjbhGs4MRSXEh/eurKhKOn3p68N/bNn9++zxw997s4voXU3qsBvNRuvcS7BmAFgG7b2aNW7lRi3Hb50bPa5bFwFz68KCMLyTq5OVrfWhTHlvHy8E4fqMi+UV1QsG9yGNRVMkpOu8l73dJ4PfnrJhJ1ernjg6/JsRA5p13GTciYHY8KHl4sIDx4cvXuUqs72wdNa4boKcQP2hBj3jMGGZkPaeBzPlNH4t3nd0bO8328hsnxE/7TLRwvpReeXdvCKuWhkztP/6CSNpidz0Ez+jkRjSflaFSv3hul/3HcsY2i9kw0ej7czNuPq+9H+3Jf4d1MV38rodGh2389INhaJ80ZAw8l9REH1bkoUC9q9LvzBz6z5ltXJFdOSMvm9RPTfrvNIIA5gQMxPJ9bzCYSuSHuQ8mvfh6IXD+tGuLfNcvw0TwgHcs50nwHjP1VuLU9IGduvi7SDTcpwY0QDFLgCASqvbe/nm0pS0rBvZ/v4+a+Kju3m5YYxh88+MDZ0PlCtV7rHfmCCEeWzBoORpH4S0a9OUSQMXrcorKlEBcHvJTFdba/31SpX68sO8vVduJp+7Vv64wN7d5YuhfSe/3V0iZoctO2Y1pAEByAGoeFIFIBwW2v1WXtHpOw/0LRr92QT9R8sxivQ8zysUZW29PfZfzVJqtOVK1YOS8tuFiqz8Yr78CZCadPVpGzU6fExXf0upKQ0sLTwkNvqqQYf4hBpVLWQZtVoDNDrQFA0ToYo3NZFwHM/XqgXvRtDCwtyjtU2gu0uvDm17+Xh5O8ro2Jd/1cBQssETkltWqT8/bfobJnydrwKxQoBmEkkrqUnD5oJeV3/Vyx5/BdFN01OMP+9tG2MMGKimm7EG+Mted/ofv/D0V9Df/p25fxh41fQPA6+a/vYM/H8AAAD//1znRQV+8yaAAAAAAElFTkSuQmCC"
  },
  "description": "Didomi builds technology to help companies put their users in control of their personal data. By doing so, they generate valuable trust and lay the groundwork for privacy-conscious growth.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "defaultStatusGroup",
    "displayName": "",
    "groupStyle": "NO_ZIPPY",
    "subParams": []
  },
  {
    "type": "GROUP",
    "name": "defaultSettingsPerRegion",
    "displayName": "Set Google Consent Mode default status",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "byRegionDefaultStatusTable",
        "displayName": "",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "displayName": "Region (leave Region field blank to apply to all regions)",
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "SELECT",
              "name": "adStorage",
              "displayName": "Ad Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Allow advertising cookies before user gives consent"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "analyticsStorage",
              "displayName": "Analytics Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "help": "Allow analytics cookies before user gives consent",
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "functionalityStorage",
              "displayName": "Functionality Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Allow website functionality cookies before user gives consent"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "personalizationStorage",
              "displayName": "Personalization Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "help": "Allow personalized recommendation cookies before user gives consent",
              "defaultValue": "denied"
            },
            "isUnique": false
          }
        ]
      }
    ],
    "help": "These fields are denied by default for all regions unless overwritten with a blank region field"
  },
  {
    "type": "GROUP",
    "name": "additionalSettings",
    "displayName": "Additional Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "adsDataRedaction",
        "checkboxText": "Redact ads data",
        "simpleValueType": true,
        "help": "To further redact your ads data when ad_storage is denied"
      },
      {
        "type": "CHECKBOX",
        "name": "urlPassThrough",
        "checkboxText": "Passing information in URLs",
        "simpleValueType": true,
        "help": "Passing ad click, client ID, and session ID information in URLs",
        "defaultValue": false
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "embedSDK",
    "displayName": "Embed Didomi",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "embedDidomi",
        "checkboxText": "Embed the Didomi Web SDK",
        "simpleValueType": true,
        "help": "Automatically embed the Didomi Web SDK from GTM. Make sure to disable this option if you embed the Didomi Web SDK directly on your website. We recommend embedding the Didomi Web SDK directly in the source code for your website as it is more performant than via GTM.",
        "defaultValue": true,
        "displayName": "Embed the Didomi Web SDK on your website from GTM"
      },
      {
        "type": "TEXT",
        "name": "publicAPIKey",
        "displayName": "Public API key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "\\b(uuid:){0,1}\\s*([a-f0-9\\\\-]*){1}\\s*"
            ]
          },
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "Your organization public API key from the Didomi Console. This must be provided for the Didomi Web SDK to be embedded on your website.",
        "enablingConditions": [
          {
            "paramName": "embedDidomi",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "enableTCF",
        "checkboxText": "Enable IAB TCF support",
        "simpleValueType": true,
        "defaultValue": true,
        "help": "Enable this option if the IAB TCF is enabled for your consent notice in the Didomi Console. See https://support.didomi.io/iab-tcf  for more information.",
        "enablingConditions": [
          {
            "paramName": "embedDidomi",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "applyGDPRGlobally",
        "checkboxText": "Apply GDPR globally",
        "simpleValueType": true,
        "defaultValue": true,
        "help": "Enable this option if you want GDPR to apply to all your users. This option must be checked if you are an EU-based company.",
        "enablingConditions": [
          {
            "paramName": "embedDidomi",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "noticeId",
        "displayName": "Notice ID",
        "simpleValueType": true,
        "defaultValue": "",
        "help": "Paste your notice ID if you want to load a specific notice irrespective of the domain name. Leave it empty to load the notice linked to your website’s domain. See https://support.didomi.io/targeting-of-a-consent-notice  for more information.",
        "enablingConditions": [
          {
            "paramName": "embedDidomi",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const gtagSet = require('gtagSet');
const encodeUriComponent = require('encodeUriComponent');
const getUrl = require('getUrl');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const setInWindow = require('setInWindow');
const callInWindow = require('callInWindow');
const copyFromWindow = require('copyFromWindow');
const createQueue = require('createQueue');
const copyFromDataLayer = require('copyFromDataLayer');

const gcmVendorId = {
  ad_storage: 'didomi:google',
  analytics_storage: 'c:googleana-4TXnJigR',
  functionality_storage: 'didomi:google',
  personalization_storage: 'didomi:google',
};

const PURPOSES_STATUSES = {
  granted: 'granted',
  denied: 'denied',
};

const GCM_PURPOSES_MAP = {
  ad_storage: 'adStorage',
  analytics_storage: 'analyticsStorage',
  functionality_storage: 'functionalityStorage',
  personalization_storage: 'personalizationStorage',
};

const splitInput = (input) => {
  return input.split(',')
    .map(entry => entry.trim())
    .filter(entry => entry.length !== 0);
};

/**
* Returns GCM purpose status (`granted` or `denied`)
* based on the boolean consent status value
*/
const getGCMPurposeStatus = (consentStatus) => {
  return consentStatus === true ? PURPOSES_STATUSES.granted : PURPOSES_STATUSES.denied;
};

/**
 * Create a TCF stub
 *
 * @param {*} fnName
 * @param {*} bufferName
 */
const createStub = (fnName, bufferName) => {
  const bufferPush = createQueue(bufferName);

  const stub = (command, parameter, callback, version) => {
    if (typeof callback !== 'function') {
      return;
    }

    bufferPush({
      command: command,
      parameter: parameter,
      callback: callback,
      version: version,
    });
  };

  // Mark the function as a stub to be able to distinguish it from the final code
  stub.stub = true;

  let windowFnName = copyFromWindow(fnName);

  if (typeof windowFnName !== 'function') {
    // No stub on the page yet, load our stub
    setInWindow(fnName, stub);
  }
};

/**
 * Determines if a consent is in an unknown state, i.e, the user has not made a choice
 *
 * @param {*} didomiState
 * @param {*} consentType
 */
const isDidomiConsentUnknown = (didomiState, consentType) => {
 return didomiState && didomiState.didomiVendorsConsentUnknown.indexOf(gcmVendorId[consentType] + ",") !== -1;
};

/**
 * Determines if a consent has been granted or not from didomiState
 *
 * @param {*} didomiState
 * @param {*} consentType
 */
const isDidomiConsentGranted = (didomiState, consentType) => {
 return didomiState && didomiState.didomiVendorsConsent.indexOf(gcmVendorId[consentType] + ",") !== -1;
};

const gcmEnabledFromSDK = () => {
  const didomiConfig = callInWindow('Didomi.getConfig');
     return didomiConfig && didomiConfig.integrations && didomiConfig.integrations.vendors && didomiConfig.integrations.vendors.gcm && didomiConfig.integrations.vendors.gcm.enable === true;
};

const updateGCMState = (eventData) => {
  if (gcmEnabledFromSDK()) return;
  const didomiState = copyFromWindow('didomiState');
  if (eventData === 'ready' && isDidomiConsentUnknown(didomiState, 'ad_storage') && isDidomiConsentUnknown(didomiState, 'analytics_storage')) return;

  const statusFromDidomiState = {};

  if (!isDidomiConsentUnknown(didomiState, 'ad_storage')) {
    statusFromDidomiState.ad_storage = getGCMPurposeStatus(isDidomiConsentGranted(didomiState, 'ad_storage'));
  }

  if (!isDidomiConsentUnknown(didomiState, 'analytics_storage')) {
    statusFromDidomiState.analytics_storage = getGCMPurposeStatus(isDidomiConsentGranted(didomiState, 'analytics_storage'));
    statusFromDidomiState.functionality_storage = getGCMPurposeStatus(isDidomiConsentGranted(didomiState, 'functionality_storage'));
    statusFromDidomiState.personalization_storage = getGCMPurposeStatus(isDidomiConsentGranted(didomiState, 'personalization_storage'));
  }
  updateConsentState(statusFromDidomiState);
};

/**
 * If GCM is not enabled in the SDK via console, it adds a listener
 * to changes in consent to update the GCM status via template
 *
 */
const setupListeners = () => {
    const didomiEventListenersPush = createQueue('didomiEventListeners');

    didomiEventListenersPush({
      event: 'consent.changed',
      listener: () => updateGCMState('consent-changed'),
   });

   const didomiOnReadyPush = createQueue('didomiOnReady');
    didomiOnReadyPush(function () {
      // Initialization code
      updateGCMState('ready');
    });
};

const setDefaultSettings = (data) => {
  // Set default consent state values for all regions
  setDefaultConsentState({
    'ad_storage': 'denied',
    'analytics_storage': 'denied',
    'functionality_storage': 'denied',
    'personalization_storage': 'denied',
    'security_storage': 'granted',
    'wait_for_update': 500,
  });

  // Set default consent state values for specific regions is set by the client
  if (data.byRegionDefaultStatusTable && data.byRegionDefaultStatusTable.length > 0) {
    data.byRegionDefaultStatusTable.forEach(settings => {
      const statusFromData = {
        'ad_storage': settings[GCM_PURPOSES_MAP.ad_storage],
        'analytics_storage': settings[GCM_PURPOSES_MAP.analytics_storage],
        'functionality_storage': settings[GCM_PURPOSES_MAP.functionality_storage],
        'personalization_storage': settings[GCM_PURPOSES_MAP.personalization_storage],
        'security_storage': 'granted',
        'wait_for_update': 500,
      };
      const regions = splitInput(settings.region);
      if (regions.length > 0) {
        statusFromData.region = regions;
      }
      // Set default consent state values
      setDefaultConsentState(statusFromData);
    });
  }
  // Set default additional settings values
  gtagSet('ads_data_redaction', data.adsDataRedaction);
  gtagSet('url_passthrough', data.urlPassThrough);
};

// Set default settings values
setDefaultSettings(data);

if (data.embedDidomi) {
    let scriptUrl = 'https://sdk.privacy-center.org/' + (data.noticeId ?  encodeUriComponent(data.publicAPIKey) + '/loader.js?target_type=notice&target=' + encodeUriComponent(data.noticeId) : encodeUriComponent(data.publicAPIKey) + '/loader.js?target=' + getUrl("host"));

  // Set window.gdprAppliesGlobally
  setInWindow('gdprAppliesGlobally', data.applyGDPRGlobally);

  if (data.enableTCF) {
    createStub(
    '__tcfapi',
    '__tcfapiBuffer'
    );
  }

  // This the logic found in src/tag/loaders/*.ejs (web sdk repo)
  if (queryPermission('inject_script', scriptUrl)) {
    setupListeners();
    injectScript(scriptUrl, data.gtmOnSuccess, data.gtmOnFailure);
  } else {
    data.gtmOnFailure();
  }
} else {
  setupListeners();
  // Call data.gtmOnSuccess when the tag is finished.
  data.gtmOnSuccess();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.didomi.io/"
              },
              {
                "type": 1,
                "string": "https://*.privacy-center.org/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gdprAppliesGlobally"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "publicAPIKey"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "noticeId"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "enableTCF"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "scriptUrl"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__tcfapiBuffer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__tcfapi"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "didomiEventListeners"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "didomiState"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "Didomi.getConfig"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "didomiOnReady"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Default consent values are set correctly (values set)
  code: |-
    mockData.byRegionDefaultStatusTable = [{
      "region": "",
      "adStorage": 'granted',
      "analyticsStorage": 'granted',
      "functionalityStorage": 'granted',
      "personalizationStorage": 'granted',
    }];


    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('setDefaultConsentState').wasCalledWith({
      'ad_storage': 'granted',
      'analytics_storage': 'granted',
      'functionality_storage': 'granted',
      'personalization_storage': 'granted',
      'security_storage': 'granted',
      'wait_for_update': 500
    });

    /*
    From a google's email:
    Because of the way Tag Manager times the application of consent updates (aligned with event boundaries), the method isConsentGranted will not be an effective way to test for any consent changes that happened during your test. Instead, I would suggest using assertApi().wasCalledWith() to ensure that the setDefaultConsentState and updateConsentState APIs were called with the expected parameters.

    assertThat(isConsentGranted('ad_storage')).isEqualTo(true);
    assertThat(isConsentGranted('analytics_storage')).isEqualTo(true);
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(true);
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(true);
    assertThat(isConsentGranted('security_storage')).isEqualTo(true);
    */;

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Default consent values are set correctly (no values set)
  code: |-
    // Default values for data checkboxes are `false`

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('setDefaultConsentState').wasCalledWith({
      'ad_storage': 'denied',
      'analytics_storage': 'denied',
      'functionality_storage': 'denied',
      'personalization_storage': 'denied',
      'security_storage': 'granted',
      'wait_for_update': 500
    });


    /*
    From a google's email:
    Because of the way Tag Manager times the application of consent updates (aligned with event boundaries), the method isConsentGranted will not be an effective way to test for any consent changes that happened during your test. Instead, I would suggest using assertApi().wasCalledWith() to ensure that the setDefaultConsentState and updateConsentState APIs were called with the expected parameters.

    assertThat(isConsentGranted('ad_storage')).isEqualTo(false);
    assertThat(isConsentGranted('analytics_storage')).isEqualTo(false);
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(false);
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(false);
    assertThat(isConsentGranted('security_storage')).isEqualTo(true);
    */

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: SDK is not embedded by default
  code: |+
    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('injectScript').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();

- name: Template values are set in Windows object
  code: |-
    mockData.embedDidomi = true;

    // Call runCode to run the template's code.
    runCode(mockData);

    const applyGDPRGlobally = copyFromWindow('gdprAppliesGlobally');

    assertThat(applyGDPRGlobally).isEqualTo(mockData.applyGDPRGlobally);

    assertApi('injectScript').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: SDK is embedded via template (no noticeId)
  code: |+
    const getUrl = require('getUrl');

    mockData.embedDidomi = true;
    mockData.noticeId = undefined;


    // Call runCode to run the template's code.
    runCode(mockData);

    const scriptUrl = 'https://sdk.privacy-center.org/' +     mockData.publicAPIKey + '/loader.js?target=' + getUrl("host");

    assertApi('injectScript').wasCalledWith(scriptUrl, success, failure);
    assertApi('gtmOnFailure').wasNotCalled();

- name: SDK is embedded via template (with noticeId)
  code: |+
    mockData.embedDidomi = true;

    // Call runCode to run the template's code.
    runCode(mockData);

    const scriptUrl = 'https://sdk.privacy-center.org/' +     mockData.publicAPIKey + '/loader.js?target_type=notice&target=' + mockData.noticeId;

    assertApi('injectScript').wasCalledWith(scriptUrl, success, failure);
    assertApi('gtmOnFailure').wasNotCalled();

- name: tcfapiBuffer is defined when TCF is enabled
  code: |-
    mockData.embedDidomi = true;

    // Call runCode to run the template's code.
    runCode(mockData);

    const tcfapi = copyFromWindow("__tcfapi");

    assertThat('createStub').isDefined();
    assertThat(typeof tcfapi).isEqualTo("function");
    assertThat(tcfapi).isDefined();

    // __tcfapiBuffer should initially be empty
    let tcfapiBuffer = copyFromWindow("__tcfapiBuffer");
    assertThat(tcfapiBuffer).isEqualTo([]);

    // __tcfapiBuffer should store the __tcfapi calls
    tcfapi('getTCData', 2, () => {});
    tcfapiBuffer = copyFromWindow("__tcfapiBuffer");
    assertThat(tcfapiBuffer[0].command).isEqualTo("getTCData");
    assertThat(tcfapiBuffer[0].parameter).isEqualTo(2);
    assertThat(typeof tcfapiBuffer[0].callback).isEqualTo("function");

    // Second call to __tcfapi to make sure that __tcfapiBuffer queue is updated
    tcfapi('addEventListener', 2, () => {});
    tcfapiBuffer = copyFromWindow("__tcfapiBuffer");
    assertThat(tcfapiBuffer[1].command).isEqualTo("addEventListener");
    assertThat(tcfapiBuffer[1].parameter).isEqualTo(2);
    assertThat(typeof tcfapiBuffer[1].callback).isEqualTo("function");


    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: It correctly sets consent empty on load
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    const didomiOnReady = copyFromWindow('didomiOnReady');
    // simulate changes coming from the SDK
    setInWindow('didomiState', didomiState, true);

    // Simulate on-ready event trigger
    didomiOnReady[0]();

    assertApi('setDefaultConsentState').wasCalledWith({
      'ad_storage': 'denied',
      'analytics_storage': 'denied',
      'functionality_storage': 'denied',
      'personalization_storage': 'denied',
      'security_storage': 'granted',
      'wait_for_update': 500
    });


    /*
    From a google's email:
    Because of the way Tag Manager times the application of consent updates (aligned with event boundaries), the method isConsentGranted will not be an effective way to test for any consent changes that happened during your test. Instead, I would suggest using assertApi().wasCalledWith() to ensure that the setDefaultConsentState and updateConsentState APIs were called with the expected parameters.

    assertThat(isConsentGranted('ad_storage')).isEqualTo(false);
    assertThat(isConsentGranted('analytics_storage')).isEqualTo(false);
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(false);
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(false);
    assertThat(isConsentGranted('security_storage')).isEqualTo(true);
    */

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: It correctly sets consent when values are set
  code: |-
    mockData.byRegionDefaultStatusTable = [{
      "region": "",
      "adStorage": 'granted',
      "analyticsStorage": 'granted',
      "functionalityStorage": 'denied',
      "personalizationStorage": 'denied',
    }];


    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('setDefaultConsentState').wasCalledWith({
      'ad_storage': 'granted',
      'analytics_storage': 'granted',
      'functionality_storage': 'denied',
      'personalization_storage': 'denied',
      'security_storage': 'granted', 'wait_for_update': 500
    });

    const didomiOnReady = copyFromWindow('didomiOnReady');
    // simulate changes coming from the SDK
    setInWindow('didomiState', didomiState, true);

    // Simulate on-ready event trigger
    didomiOnReady[0]();

    /*
    From a google's email:
    Because of the way Tag Manager times the application of consent updates (aligned with event boundaries), the method isConsentGranted will not be an effective way to test for any consent changes that happened during your test. Instead, I would suggest using assertApi().wasCalledWith() to ensure that the setDefaultConsentState and updateConsentState APIs were called with the expected parameters.

    assertThat(isConsentGranted('ad_storage')).isEqualTo(true);
    assertThat(isConsentGranted('analytics_storage')).isEqualTo(true);
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(false);
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(false);
    assertThat(isConsentGranted('security_storage')).isEqualTo(true);
    */

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: It correctly sets consent given on the page
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('setDefaultConsentState').wasCalledWith({
      'ad_storage': 'denied',
      'analytics_storage': 'denied',
      'functionality_storage': 'denied',
      'personalization_storage': 'denied',
      'security_storage': 'granted',
      'wait_for_update': 500
    });

    /*
    From a google's email:
    Because of the way Tag Manager times the application of consent updates (aligned with event boundaries), the method isConsentGranted will not be an effective way to test for any consent changes that happened during your test. Instead, I would suggest using assertApi().wasCalledWith() to ensure that the setDefaultConsentState and updateConsentState APIs were called with the expected parameters.

    assertThat(isConsentGranted('ad_storage')).isEqualTo(false);
    assertThat(isConsentGranted('analytics_storage')).isEqualTo(false);
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(false);
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(false);
    assertThat(isConsentGranted('security_storage')).isEqualTo(true);
    */

    const didomiEventListeners = copyFromWindow('didomiEventListeners');
    // simulate changes coming from the SDK
    // user gives consent to both google and google analytics vendors and purposes
    didomiState.didomiVendorsConsent = "didomi:google,c:googleana-4TXnJigR,";
    didomiState.didomiVendorsConsentUnknown = "";
    setInWindow('didomiState', didomiState, true);

    // Simulate on-changed event trigger
    didomiEventListeners[0].listener();

    assertThat(isConsentGranted('ad_storage')).isEqualTo(true);
    assertThat(isConsentGranted('analytics_storage')).isEqualTo(true);
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(true);
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(true);
    assertThat(isConsentGranted('security_storage')).isEqualTo(true);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: It correctly sets consent available from the previous page
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    const didomiOnReady = copyFromWindow('didomiOnReady');
    // simulate changes coming from the SDK
    // user has given consent to both google and google analytics vendors and purposes
    didomiState.didomiVendorsConsent = "didomi:google,c:googleana-4TXnJigR,";
    didomiState.didomiVendorsConsentUnknown = "";
    setInWindow('didomiState', didomiState, true);

    // Simulate on-ready event trigger
    didomiOnReady[0]();

    assertThat(isConsentGranted('ad_storage')).isEqualTo(true);
    assertThat(isConsentGranted('analytics_storage')).isEqualTo(true);
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(true);
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(true);
    assertThat(isConsentGranted('security_storage')).isEqualTo(true);


    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: It correctly sets consent available from the previous page and changed on
    the current page
  code: "// Call runCode to run the template's code.\nrunCode(mockData);\n\nconst\
    \ didomiOnReady = copyFromWindow('didomiOnReady');\n// simulate changes coming\
    \ from the SDK\n// user has given consent to both ad and analytics storage\ndidomiState.didomiVendorsConsent\
    \ = \"didomi:google,c:googleana-4TXnJigR,\";\ndidomiState.didomiVendorsConsentUnknown\
    \ = \"\";\nsetInWindow('didomiState', didomiState, true);\n\n// Simulate on-ready\
    \ event trigger\ndidomiOnReady[0]();\n\nassertApi('setDefaultConsentState').wasCalledWith({\n\
    \  'ad_storage': 'denied',\n  'analytics_storage': 'denied',\n  'functionality_storage':\
    \ 'denied',\n  'personalization_storage': 'denied',\n  'security_storage': 'granted',\n\
    \  'wait_for_update': 500\n});\n/*\nFrom a google's email:\nBecause of the way\
    \ Tag Manager times the application of consent updates (aligned with event boundaries),\
    \ the method isConsentGranted will not be an effective way to test for any consent\
    \ changes that happened during your test. Instead, I would suggest using assertApi().wasCalledWith()\
    \ to ensure that the setDefaultConsentState and updateConsentState APIs were called\
    \ with the expected parameters.\n\nassertThat(isConsentGranted('ad_storage')).isEqualTo(true);\n\
    assertThat(isConsentGranted('analytics_storage')).isEqualTo(true);\nassertThat(isConsentGranted('functionality_storage')).isEqualTo(true);\n\
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(true);\n*/ \n\
    \nassertThat(isConsentGranted('security_storage')).isEqualTo(true);\nassertApi('updateConsentState').wasCalledWith({'ad_storage':\
    \ 'granted',\n  'analytics_storage': 'granted',\n    'functionality_storage':\
    \ 'granted',\n  'personalization_storage': 'granted'});\n\nconst didomiEventListeners\
    \ = copyFromWindow('didomiEventListeners');\n// simulate changes coming from the\
    \ SDK\n// user changes consent for both ad and analytics storage\ndidomiState.didomiVendorsConsentDenied\
    \ = \"didomi:google,c:googleana-4TXnJigR,\";\ndidomiState.didomiVendorsConsent\
    \ = \"\";\ndidomiState.didomiVendorsConsentUnknown = \"\";\nsetInWindow('didomiState',\
    \ didomiState, true);\n\n// Simulate on-changed event trigger\ndidomiEventListeners[0].listener();\n\
    \n\nassertApi('updateConsentState').wasCalledWith({'ad_storage': 'denied',\n \
    \ 'analytics_storage': 'denied',\n    'functionality_storage': 'denied',\n  'personalization_storage':\
    \ 'denied'});\nassertThat(isConsentGranted('security_storage')).isEqualTo(true);\n\
    \n/*\nassertThat(isConsentGranted('ad_storage')).isEqualTo(false);\nassertThat(isConsentGranted('analytics_storage')).isEqualTo(false);\n\
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(false);\nassertThat(isConsentGranted('personalization_storage')).isEqualTo(false);\n\
    assertThat(isConsentGranted('security_storage')).isEqualTo(true);\n*/\n\n\n//\
    \ Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: It correctly sets consent when just one of the default states is set (analytics)
  code: "// Simulates one of the default values set to true\nmockData.byRegionDefaultStatusTable\
    \ = [{\n  \"region\": \"\",\n  \"adStorage\": 'denied',\n  \"analyticsStorage\"\
    : 'granted',\n  \"functionalityStorage\": 'denied',\n  \"personalizationStorage\"\
    : 'denied',\n}];\n\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \nassertApi('setDefaultConsentState').wasCalledWith({\n  'ad_storage': 'denied',\n\
    \  'analytics_storage': 'granted',\n  'functionality_storage': 'denied',\n  'personalization_storage':\
    \ 'denied',\n  'security_storage': 'granted', 'wait_for_update': 500\n});\n\n\
    const didomiOnReady = copyFromWindow('didomiOnReady');\n\n// simulate changes\
    \ coming from the SDK\n// user has given consent to google \n// google analytics\
    \ is still in unknown state\ndidomiState.didomiVendorsConsent = \"didomi:google,\"\
    ;\ndidomiState.didomiVendorsConsentUnknown = \"c:googleana-4TXnJigR,\";\nsetInWindow('didomiState',\
    \ didomiState, true);\n\n// Simulate on-ready event trigger\ndidomiOnReady[0]();\n\
    \nassertThat(isConsentGranted('ad_storage')).isEqualTo(true);\nassertThat(isConsentGranted('analytics_storage')).isEqualTo(true);\n\
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(true);\nassertThat(isConsentGranted('personalization_storage')).isEqualTo(true);\n\
    assertThat(isConsentGranted('security_storage')).isEqualTo(true);\n\n\nassertThat(isConsentGranted('security_storage')).isEqualTo(true);\n\
    assertApi('updateConsentState').wasCalledWith({\n  'ad_storage': 'granted',\n\
    });\n\n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: It correctly sets consent when just one of the default states is set (storage)
  code: "// Simulates one of the default values set to true\nmockData.byRegionDefaultStatusTable\
    \ = [{\n  \"region\": \"\",\n  \"adStorage\": 'granted',\n  \"analyticsStorage\"\
    : 'denied',\n  \"functionalityStorage\": 'denied',\n  \"personalizationStorage\"\
    : 'denied',\n}];\n\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \nassertApi('setDefaultConsentState').wasCalledWith({'ad_storage': 'granted',\n\
    \  'analytics_storage': 'denied',\n  'functionality_storage': 'denied',\n  'personalization_storage':\
    \ 'denied',\n  'security_storage': 'granted', 'wait_for_update': 500});\n\nconst\
    \ didomiOnReady = copyFromWindow('didomiOnReady');\n\n// simulate changes coming\
    \ from the SDK\n// user has given consent to google analytics \n// google (storage)\
    \ is still in unknown state\ndidomiState.didomiVendorsConsent = \"c:googleana-4TXnJigR,\"\
    ;\ndidomiState.didomiVendorsConsentUnknown = \"didomi:google,\";\nsetInWindow('didomiState',\
    \ didomiState, true);\n\n// Simulate on-ready event trigger\ndidomiOnReady[0]();\n\
    \nassertThat(isConsentGranted('security_storage')).isEqualTo(true);\nassertApi('updateConsentState').wasCalledWith({\n\
    \  'analytics_storage': 'granted',\n  'functionality_storage': 'denied',\n  'personalization_storage':\
    \ 'denied'\n});\n\n\n/*\nFrom a google's email:\nBecause of the way Tag Manager\
    \ times the application of consent updates (aligned with event boundaries), the\
    \ method isConsentGranted will not be an effective way to test for any consent\
    \ changes that happened during your test. Instead, I would suggest using assertApi().wasCalledWith()\
    \ to ensure that the setDefaultConsentState and updateConsentState APIs were called\
    \ with the expected parameters.\n\nassertThat(isConsentGranted('ad_storage')).isEqualTo(true);\n\
    assertThat(isConsentGranted('analytics_storage')).isEqualTo(true);\nassertThat(isConsentGranted('functionality_storage')).isEqualTo(false);\n\
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(false);\nassertThat(isConsentGranted('security_storage')).isEqualTo(true);\n\
    */\n\n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: gtagSet is correctly call for ads_data_redaction and url_passthrough values
  code: |+
    mockData.adsDataRedaction = true;
    mockData.urlPassThrough = false;

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('gtagSet').wasCalledWith('ads_data_redaction', true);
    assertApi('gtagSet').wasCalledWith('url_passthrough', false);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();




- name: Default consent values are set correctly for multiple regions
  code: |-
    mockData.byRegionDefaultStatusTable = [{
      "region": "US-CA, US-CO",
      "adStorage": 'granted',
      "analyticsStorage": 'granted',
      "functionalityStorage": 'denied',
      "personalizationStorage": 'denied',
    }];


    // Call runCode to run the template's code.
    runCode(mockData);


    assertApi('setDefaultConsentState').wasCalledWith({
      'region': ['US-CA','US-CO'],
      'ad_storage': 'granted',
      'analytics_storage': 'granted',
      'functionality_storage': 'denied',
      'personalization_storage': 'denied',
      'security_storage': 'granted',
      'wait_for_update': 500
    });



    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  // Create injectScript mock
  let success, failure;
  const copyFromWindow = require('copyFromWindow');
  const isConsentGranted = require('isConsentGranted');
  const setInWindow = require('setInWindow');
  const copyFromDataLayer = require('copyFromDataLayer');

  mock('injectScript', (url, onsuccess, onfailure) => {
    success = onsuccess;
    failure = onfailure;
    onsuccess();
  });

  let mockData = {
    // Mocked field values
    "embedDidomi":false,
    "publicAPIKey":"7685b6f7-3062-491b-ba50-207f440951dc",
    "enableTCF":true,
    "applyGDPRGlobally":true,
    "noticeId":"BLBwUdiE",
    "byRegionDefaultStatusTable": [{
          "region": "",
        "adStorage": 'denied',
    "analyticsStorage": 'denied',
    "functionalityStorage": 'denied',
    "personalizationStorage": 'denied',
    }],
  };

  let didomiState = {
    "didomiExperimentId": "",
    "didomiExperimentUserGroup": "",
    "didomiGDPRApplies": 1,
    "didomiIABConsent": "CPLCx4ZPLCx4ZAHABBENBkCgAAAAAE7AAAAAAAALzgAgLzAA.YAAACdgAAAAA",
    "didomiPurposesConsent": "",
    "didomiPurposesConsentDenied": "",
    "didomiPurposesConsentUnknown":               "cookies,create_ads_profile,select_personalized_ads,measure_content_performance,",
    "didomiVendorsConsent": "",
    "didomiVendorsConsentDenied": "",
    "didomiVendorsConsentUnknown": "didomi:google,c:googleana-4TXnJigR,",
    "didomiVendorsRawConsent": "",
    "didomiVendorsRawConsentDenied": "",
  "didomiVendorsRawConsentUnknown": "didomi:google,c:googleana-4TXnJigR,",
  };


___NOTES___

Created on 8/9/2021, 10:26:16 PM


